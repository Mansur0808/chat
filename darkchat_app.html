<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkChat - Современный чат</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .auth-logo {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            color: #888;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .google-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
        }

        .divider {
            margin: 20px 0;
            position: relative;
            text-align: center;
            color: #666;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, #333, transparent);
        }

        .divider span {
            background: rgba(0, 0, 0, 0.9);
            padding: 0 15px;
        }

        .guest-btn {
            background: transparent;
            color: #888;
            border: 1px solid #333;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .guest-btn:hover {
            border-color: #555;
            color: #fff;
        }

        /* Main App */
        .app-container {
            display: none;
            height: 100vh;
            background: #0a0a0a;
        }

        .app-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #667eea;
            object-fit: cover;
            display: none;
        }

        .user-name {
            font-weight: 600;
            color: #fff;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ff3742;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #888;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn.active {
            color: #667eea;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .tab-btn:hover:not(.active) {
            color: #bbb;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            height: calc(100vh - 140px);
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* Friends Tab */
        .friends-header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .search-box {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 25px;
            padding: 12px 20px;
            width: 100%;
            color: #fff;
            font-size: 14px;
        }

        .search-box::placeholder {
            color: #666;
        }

        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .friend-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #667eea;
        }

        .friend-item.active {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            position: relative;
        }

        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #0a0a0a;
        }

        .status-online { background: #2ed573; }
        .status-away { background: #ffa502; }
        .status-offline { background: #747d8c; }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .friend-status {
            color: #888;
            font-size: 12px;
        }

        .friend-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #667eea;
            border-color: #667eea;
        }

        /* Private Chat Container */
        .private-chat-container {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .private-chat-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .selected-friend-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selected-friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .selected-friend-details {
            display: flex;
            flex-direction: column;
        }

        .selected-friend-name {
            color: #fff;
            font-weight: 600;
        }

        .selected-friend-status {
            color: #888;
            font-size: 12px;
        }

        .back-btn {
            background: #444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #555;
        }

        /* Chat Area */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-name {
            color: #fff;
            font-weight: 600;
            font-size: 16px;
        }

        .chat-status {
            color: #888;
            font-size: 12px;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .game-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .game-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #0a0a0a;
            position: relative;
        }

        .messages-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .message.sent .message-time {
            text-align: right;
        }

        /* Input Area */
        .input-area {
            background: #1a1a1a;
            border-top: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 25px;
            padding: 12px 20px;
            color: #fff;
            font-size: 14px;
        }

        .message-input::placeholder {
            color: #666;
        }

        .send-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Game Modal */
        .game-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .game-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border: 1px solid #444;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .game-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #fff;
        }

        .game-area {
            display: none;
            margin-top: 20px;
        }

        /* Tic Tac Toe */
        .tic-tac-toe {
            text-align: center;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            width: 300px;
            height: 300px;
            margin: 20px auto;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
        }

        .cell {
            background: #2a2a2a;
            border: none;
            color: #fff;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cell:hover {
            background: #3a3a3a;
        }

        .cell.x {
            color: #667eea;
        }

        .cell.o {
            color: #764ba2;
        }

        .game-status {
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .reset-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4c93);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
            
            .game-board {
                width: 250px;
                height: 250px;
            }
            
            .auth-card {
                margin: 20px;
                padding: 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-container" id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">💬</div>
            <h1 class="auth-title">DarkChat</h1>
            <p class="auth-subtitle">Подключайтесь к современному общению</p>
            
            <button class="google-btn" onclick="signInWithGoogle()">
                <span>🔍</span>
                Войти через Google
            </button>
            
            <div class="divider">
                <span>или</span>
            </div>
            
            <!-- Удаляю кнопку входа как гость -->
            <!-- <button class="guest-btn" onclick="signInAsGuest()">Войти как гость</button> -->
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="mainApp">
        <!-- Header -->
        <div class="app-header">
            <div class="user-info">
                <img class="user-avatar" id="userAvatar" src="" alt="Avatar">
                <span class="user-name" id="userName">Пользователь</span>
            </div>
            <button class="logout-btn" onclick="logout()">Выйти</button>
            <button class="logout-btn" onclick="renameUser()">Переименовать</button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('friends')">Друзья</button>
            <button class="tab-btn" onclick="switchTab('general')">Общий чат</button>
        </div>

        <!-- Friends Tab -->
        <div class="tab-content active" id="friendsTab">
            <!-- Friends List -->
            <div id="friendsList">
                <div class="friends-header">
                    <input type="text" class="search-box" placeholder="Поиск пользователей..." onkeyup="searchFriends(this.value)">
                </div>
                <div class="friends-list" id="usersList">
                    <!-- Друзья будут здесь -->
                </div>
                <div class="friends-list" id="recommendedList">
                    <!-- Рекомендованные пользователи будут здесь -->
                </div>
            </div>

            <!-- Private Chat Container -->
            <div class="private-chat-container" id="privateChatContainer">
                <div class="private-chat-header">
                    <div class="selected-friend-info">
                        <div class="selected-friend-avatar" id="selectedFriendAvatar">А</div>
                        <div class="selected-friend-details">
                            <div class="selected-friend-name" id="selectedFriendName">Анна Петрова</div>
                            <div class="selected-friend-status" id="selectedFriendStatus">Сейчас в сети</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="game-btn" onclick="showGames()">🎮 Игры</button>
                        <button class="back-btn" onclick="closeFriendChat()">← Назад</button>
                    </div>
                </div>
                
                <div class="messages-container" id="privateMessagesContainer">
                    <!-- Private messages will be displayed here -->
                </div>
                
                <div class="input-area">
                    <input type="text" class="message-input" id="privateMessageInput" placeholder="Введите сообщение..." onkeypress="handlePrivateKeyPress(event)">
                    <button class="send-btn" onclick="sendPrivateMessage()">➤</button>
                </div>
            </div>
        </div>

        <!-- General Chat Tab -->
        <div class="tab-content" id="generalTab">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-info">
                        <div>
                            <div class="chat-name">Общий чат</div>
                            <div class="chat-status">Открытый канал для всех</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="game-btn" onclick="showGames()">🎮 Игры</button>
                    </div>
                </div>
                
                <div class="messages-container" id="generalMessagesContainer">
                    <!-- General messages will be displayed here -->
                </div>
                
                <div class="input-area">
                    <input type="text" class="message-input" id="generalMessageInput" placeholder="Введите сообщение в общий чат..." onkeypress="handleGeneralKeyPress(event)">
                    <button class="send-btn" onclick="sendGeneralMessage()">➤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="game-modal" id="gameModal">
        <div class="game-content">
            <button class="close-btn" onclick="closeGames()">×</button>
            <h2 style="color: #667eea; margin-bottom: 10px;">Мини-игры</h2>
            <p style="color: #888;">Выберите игру для совместного времяпрепровождения</p>
            
            <div class="game-grid">
                <div class="game-card" onclick="startTicTacToe()">
                    <div class="game-icon">⭕</div>
                    <h3 style="color: #fff; margin-bottom: 5px;">Крестики-Нолики</h3>
                    <p style="color: #888; font-size: 12px;">Классическая игра 3x3</p>
                </div>
                
                <div class="game-card" onclick="startWordGame()">
                    <div class="game-icon">📝</div>
                    <h3 style="color: #fff; margin-bottom: 5px;">Игра в слова</h3>
                    <p style="color: #888; font-size: 12px;">Составляйте слова по очереди</p>
                </div>
                
                <div class="game-card" onclick="startQuiz()">
                    <div class="game-icon">🧠</div>
                    <h3 style="color: #fff; margin-bottom: 5px;">Викторина</h3>
                    <p style="color: #888; font-size: 12px;">Проверьте свои знания</p>
                </div>
                
                <div class="game-card" onclick="startDrawing()">
                    <div class="game-icon">🎨</div>
                    <h3 style="color: #fff; margin-bottom: 5px;">Рисование</h3>
                    <p style="color: #888; font-size: 12px;">Рисуйте вместе с друзьями</p>
                </div>
            </div>
            
            <!-- Game Area -->
            <div class="game-area" id="gameArea">
                <!-- Games will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js" type="module"></script>

    <script type="module">
        // --- UI Screen Management ---
        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }
        // --- User Info Update ---
        function updateUserInfo() {
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            if (currentUser) {
                userName.textContent = currentUser.displayName || 'Пользователь';
                userAvatar.style.display = 'none'; // Если аватар не используешь
            }
        }
        // --- Key Press Handlers ---
        window.handleGeneralKeyPress = function(event) {
            if (event.key === 'Enter') {
                window.sendGeneralMessage();
            }
        };
        window.handlePrivateKeyPress = function(event) {
            if (event.key === 'Enter') {
                window.sendPrivateMessage();
            }
        };

        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, serverTimestamp, update, off, get, child, onChildAdded, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCTOnt_N9NBRaOt5qcn_0zc17reeOwjKUo",
            authDomain: "muliplayer-game-f6da2.firebaseapp.com",
            databaseURL: "https://muliplayer-game-f6da2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "muliplayer-game-f6da2",
            storageBucket: "muliplayer-game-f6da2.appspot.com",
            messagingSenderId: "51658876279",
            appId: "1:51658876279:web:87c89896c1052a44092d72",
            measurementId: "G-XQD6BPJESJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentFriend = null;
        let gameState = {
            ticTacToe: {
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X',
                gameOver: false,
                winner: null
            }
        };

        // --- User Status ---
        async function setUserStatus(uid, status) {
            if (!uid) return;
            let providerId = 'anonymous';
            let email = '';
            if (currentUser && currentUser.providerData && currentUser.providerData.length > 0) {
                providerId = currentUser.providerData[0].providerId;
                email = currentUser.email || '';
            }
            await set(ref(db, `users/${uid}`), {
                uid: uid,
                displayName: currentUser.displayName || 'Пользователь',
                status: status,
                lastSeen: Date.now(),
                providerId: providerId,
                email: email
            });
        }

        // --- Auth ---
        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                await setUserStatus(currentUser.uid, 'online');
                showMainApp();
            } catch (error) {
                console.error('Error signing in with Google:', error);
                alert('Ошибка входа через Google');
            }
        };

        window.logout = async function() {
            try {
                await setUserStatus(currentUser.uid, 'offline');
                await signOut(auth);
                currentUser = null;
                showAuthScreen();
            } catch (error) {
                console.error('Error signing out:', error);
            }
        };

        window.addEventListener('beforeunload', async function() {
            if (currentUser) {
                await setUserStatus(currentUser.uid, 'offline');
            }
        });

        // --- User Status Listener ---
        function loadFriendsStatuses() {
            const friends = [
                { uid: 'friend1', name: 'Анна Петрова', avatar: 'А' },
                { uid: 'friend2', name: 'Максим Козлов', avatar: 'М' },
                { uid: 'friend3', name: 'Елена Смирнова', avatar: 'Е' },
                { uid: 'friend4', name: 'Дмитрий Волков', avatar: 'Д' },
            ];
            friends.forEach(friend => {
                const statusRef = ref(db, `users/${friend.uid}`);
                onValue(statusRef, (snapshot) => {
                    const data = snapshot.val();
                    const friendItems = document.querySelectorAll('.friend-item');
                    friendItems.forEach(item => {
                        if (item.textContent.includes(friend.name)) {
                            const statusDiv = item.querySelector('.status-indicator');
                            statusDiv.classList.remove('status-online', 'status-away', 'status-offline');
                            if (data && data.status === 'online') {
                                statusDiv.classList.add('status-online');
                            } else {
                                statusDiv.classList.add('status-offline');
                            }
                        }
                    });
                });
            });
        }

        // --- General Chat ---
        function loadGeneralMessages() {
            const messagesRef = ref(db, 'general_messages');
            const messagesContainer = document.getElementById('generalMessagesContainer');
            messagesContainer.innerHTML = '';
            onChildAdded(messagesRef, (snapshot) => {
                const data = snapshot.val();
                addGeneralMessage(data.text, data.userId === currentUser?.uid, data.user, snapshot.key, data.reactions || {}, data.timestamp);
            });
            // Listen for reactions
            onValue(messagesRef, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(child => {
                    const data = child.val();
                    addGeneralMessage(data.text, data.userId === currentUser?.uid, data.user, child.key, data.reactions || {}, data.timestamp);
                });
            });
        }

        window.sendGeneralMessage = function() {
            const input = document.getElementById('generalMessageInput');
            const message = input.value.trim();
            if (message && currentUser) {
                push(ref(db, 'general_messages'), {
                    text: message,
                    user: currentUser.displayName || 'Пользователь',
                    userId: currentUser.uid,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        };

        // --- Private Chat ---
        function getChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        function listenPrivateChat(friendUid) {
            const chatId = getChatId(currentUser.uid, friendUid);
            const messagesRef = ref(db, `private_chats/${chatId}`);
            const messagesContainer = document.getElementById('privateMessagesContainer');
            messagesContainer.innerHTML = '';
            onChildAdded(messagesRef, (snapshot) => {
                const data = snapshot.val();
                addPrivateMessage(data.text, data.from === currentUser.uid, snapshot.key, data.reactions || {}, data.timestamp);
            });
            // Listen for reactions
            onValue(messagesRef, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(child => {
                    const data = child.val();
                    addPrivateMessage(data.text, data.from === currentUser.uid, child.key, data.reactions || {}, data.timestamp);
                });
            });
        }

        window.sendPrivateMessage = function() {
            const input = document.getElementById('privateMessageInput');
            const message = input.value.trim();
            if (message && currentFriend) {
                const chatId = getChatId(currentUser.uid, currentFriend);
                push(ref(db, `private_chats/${chatId}`), {
                    text: message,
                    from: currentUser.uid,
                    to: currentFriend,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        };

        // --- Auth State Observer ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showMainApp();
                updateUserInfo();
                loadGeneralMessages();
                loadAllUsersAndFriends(); // динамический список пользователей и друзей
            } else {
                currentUser = null;
                showAuthScreen();
            }
        });

        // --- Tab Management ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (tabName === 'general') {
                closeFriendChat();
            }
        };

        // --- Friend Management ---
        window.selectFriend = function(element, friendId) {
            document.querySelectorAll('.friend-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
            currentFriend = friendId;
            showPrivateChat(element);
            listenPrivateChat(friendId);
        };

        function showPrivateChat(friendElement) {
            const friendsList = document.getElementById('friendsList');
            const privateChatContainer = document.getElementById('privateChatContainer');
            
            // Hide friends list and show chat
            friendsList.style.display = 'none';
            privateChatContainer.style.display = 'flex';
            
            // Update chat header
            const friendName = friendElement.querySelector('.friend-name').textContent;
            const friendStatus = friendElement.querySelector('.friend-status').textContent;
            const friendAvatar = friendElement.querySelector('.friend-avatar').textContent;
            
            document.getElementById('selectedFriendName').textContent = friendName;
            document.getElementById('selectedFriendStatus').textContent = friendStatus;
            document.getElementById('selectedFriendAvatar').textContent = friendAvatar;
            
            // Clear previous messages and add some sample messages
            const messagesContainer = document.getElementById('privateMessagesContainer');
            messagesContainer.innerHTML = '';
            
            // Add sample messages
            addPrivateMessage('Привет! Как дела?', false);
            addPrivateMessage('Привет! Все отлично, спасибо! А у тебя как?', true);
            addPrivateMessage('Тоже все хорошо! Что планируешь на выходные?', false);
        }

        window.closeFriendChat = function() {
            const friendsList = document.getElementById('friendsList');
            const privateChatContainer = document.getElementById('privateChatContainer');
            
            // Show friends list and hide chat
            friendsList.style.display = 'block';
            privateChatContainer.style.display = 'none';
            
            // Clear selection
            currentFriend = null;
            document.querySelectorAll('.friend-item').forEach(item => item.classList.remove('active'));
        };

        // --- Search Friends ---
        window.searchFriends = function(query) {
            const friendItems = document.querySelectorAll('.friend-item');
            friendItems.forEach(item => {
                const friendName = item.querySelector('.friend-name').textContent.toLowerCase();
                if (friendName.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // --- Dynamic Users List ---
        function renderUsersLists(users, friendsMap) {
            const usersList = document.getElementById('usersList');
            const recommendedList = document.getElementById('recommendedList');
            usersList.innerHTML = '';
            recommendedList.innerHTML = '';
            users.forEach(user => {
                if (!user.uid) return;
                const isSelf = currentUser && user.uid === currentUser.uid;
                const isFriend = friendsMap[user.uid];
                const userDiv = document.createElement('div');
                userDiv.className = 'friend-item';
                userDiv.onclick = !isSelf ? function() { window.selectFriend(userDiv, user.uid); } : null;
                let subInfo = 'Гость';
                if (user.providerId === 'google.com') {
                    subInfo = user.email ? user.email : (user.displayName || 'Google пользователь');
                }
                userDiv.innerHTML = `
                    <div class="friend-avatar">${user.displayName ? user.displayName[0] : 'U'}
                        <div class="status-indicator ${user.status === 'online' ? 'status-online' : 'status-offline'}"></div>
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${user.displayName || 'Пользователь'}</div>
                        <div class="friend-status">${user.status === 'online' ? 'Сейчас в сети' : 'Не в сети'}</div>
                        <div style="font-size:11px;color:#888;">${subInfo}</div>
                    </div>
                    <div class="friend-actions">
                        ${!isSelf && !isFriend ? `<button class="action-btn" onclick="event.stopPropagation(); addToFriends('${user.uid}')" title="Добавить в друзья">+</button>` : ''}
                        ${!isSelf ? `<button class="action-btn" onclick="event.stopPropagation(); renameAnyUser('${user.uid}')" title="Переименовать пользователя">✏️</button>` : ''}
                    </div>
                `;
                if (isFriend && !isSelf) {
                    usersList.appendChild(userDiv);
                } else if (!isSelf && !isFriend) {
                    recommendedList.appendChild(userDiv);
                }
            });
        }

        function loadAllUsersAndFriends() {
            const usersRef = ref(db, 'users');
            const friendsRef = ref(db, `friends/${currentUser.uid}`);
            onValue(usersRef, (usersSnap) => {
                const users = [];
                usersSnap.forEach(child => {
                    users.push(child.val());
                });
                onValue(friendsRef, (friendsSnap) => {
                    const friendsMap = friendsSnap ? friendsSnap.val() || {} : {};
                    renderUsersLists(users, friendsMap);
                });
            });
        }

        window.addToFriends = function(uid) {
            if (!currentUser || !uid) return;
            const myFriendsRef = ref(db, `friends/${currentUser.uid}/${uid}`);
            set(myFriendsRef, true);
            // Можно добавить уведомление или визуальный отклик
        };

        // --- Переименование пользователя ---
        window.renameUser = function() {
            const newName = prompt('Введите новое имя:');
            if (newName && currentUser) {
                set(ref(db, `users/${currentUser.uid}/displayName`), newName);
            }
        };

        window.renameAnyUser = function(uid) {
            const newName = prompt('Введите новое имя для пользователя:');
            if (newName && uid) {
                set(ref(db, `users/${uid}/displayName`), newName);
            }
        };

        // --- Message handling ---
        function addPrivateMessage(text, isSent, msgId = null, reactions = {}, timestamp = null) {
            const messagesContainer = document.getElementById('privateMessagesContainer');
            const messageDiv = document.createElement('div');
            let timeString = '';
            if (timestamp) {
                const date = new Date(timestamp);
                timeString = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
            } else {
                const now = new Date();
                timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            }
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            let reactionsHtml = '';
            if (msgId) {
                reactionsHtml = renderReactions(msgId, reactions, 'private');
            }
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text}
                    <div class="message-time">${timeString}</div>
                    ${reactionsHtml}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addGeneralMessage(text, isSent, userName = null, msgId = null, reactions = {}, timestamp = null) {
            const messagesContainer = document.getElementById('generalMessagesContainer');
            const messageDiv = document.createElement('div');
            let timeString = '';
            if (timestamp) {
                const date = new Date(timestamp);
                timeString = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
            } else {
                const now = new Date();
                timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            }
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            let messageContent = text;
            if (!isSent && userName) {
                messageContent = `<strong>${userName}:</strong> ${text}`;
            }
            let reactionsHtml = '';
            if (msgId) {
                reactionsHtml = renderReactions(msgId, reactions, 'general');
            }
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${messageContent}
                    <div class="message-time">${timeString}</div>
                    ${reactionsHtml}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderReactions(msgId, reactions, chatType) {
            const emojis = ['👍', '❤️', '👎'];
            let html = '<div style="margin-top:5px; font-size:18px; display:flex; gap:8px;">';
            emojis.forEach(emoji => {
                const count = reactions && reactions[emoji] ? Object.keys(reactions[emoji]).length : 0;
                html += `<span style="cursor:pointer;" onclick="window.reactToMessage('${msgId}','${emoji}','${chatType}')">${emoji}${count > 0 ? ' ' + count : ''}</span>`;
            });
            html += '</div>';
            return html;
        }

        window.reactToMessage = function(msgId, emoji, chatType) {
            if (!currentUser) return;
            let msgRef;
            if (chatType === 'general') {
                msgRef = ref(db, `general_messages/${msgId}/reactions/${emoji}/${currentUser.uid}`);
            } else {
                const chatId = getChatId(currentUser.uid, currentFriend);
                msgRef = ref(db, `private_chats/${chatId}/${msgId}/reactions/${emoji}/${currentUser.uid}`);
            }
            set(msgRef, true);
        };

        // --- Video call functionality ---
        window.startVideoCall = function(friendId) {
            console.log('Video call requested for:', friendId);
            alert('Функция видеозвонков будет доступна в ближайшее время!');
        };

        // --- Game functions ---
        window.showGames = function() {
            document.getElementById('gameModal').style.display = 'flex';
        };

        window.closeGames = function() {
            document.getElementById('gameModal').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
        };

        window.startTicTacToe = function() {
            resetTicTacToe();
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="tic-tac-toe">
                    <h3>🎮 Крестики-нолики</h3>
                    <div class="game-status" id="gameStatus">Ход игрока X</div>
                    <div class="game-board" id="gameBoard">
                        ${Array(9).fill(0).map((_, i) => `<button class="cell" onclick="makeMove(${i})"></button>`).join('')}
                    </div>
                    <button class="reset-btn" onclick="resetTicTacToe()">Новая игра</button>
                </div>
            `;
            gameArea.style.display = 'block';
        };

        window.makeMove = function(index) {
            if (gameState.ticTacToe.board[index] || gameState.ticTacToe.gameOver) return;
            
            gameState.ticTacToe.board[index] = gameState.ticTacToe.currentPlayer;
            
            const cell = document.querySelectorAll('.cell')[index];
            cell.textContent = gameState.ticTacToe.currentPlayer;
            cell.classList.add(gameState.ticTacToe.currentPlayer.toLowerCase());
            
            if (checkWinner()) {
                gameState.ticTacToe.gameOver = true;
                gameState.ticTacToe.winner = gameState.ticTacToe.currentPlayer;
                document.getElementById('gameStatus').textContent = `Игрок ${gameState.ticTacToe.currentPlayer} выиграл! 🎉`;
            } else if (gameState.ticTacToe.board.every(cell => cell)) {
                gameState.ticTacToe.gameOver = true;
                document.getElementById('gameStatus').textContent = 'Ничья! 🤝';
            } else {
                gameState.ticTacToe.currentPlayer = gameState.ticTacToe.currentPlayer === 'X' ? 'O' : 'X';
                document.getElementById('gameStatus').textContent = `Ход игрока ${gameState.ticTacToe.currentPlayer}`;
            }
        };

        window.resetTicTacToe = function() {
            gameState.ticTacToe = {
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X',
                gameOver: false,
                winner: null
            };
            
            if (document.getElementById('gameStatus')) {
                document.getElementById('gameStatus').textContent = 'Ход игрока X';
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('x', 'o');
                });
            }
        };

        function checkWinner() {
            const board = gameState.ticTacToe.board;
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6] // diagonals
            ];
            
            return winPatterns.some(pattern => {
                const [a, b, c] = pattern;
                return board[a] && board[a] === board[b] && board[a] === board[c];
            });
        }

        window.startWordGame = function() {
            alert('Игра в слова скоро будет доступна!');
        };

        window.startQuiz = function() {
            alert('Викторина скоро будет доступна!');
        };

        window.startDrawing = function() {
            alert('Рисование скоро будет доступно!');
        };

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
            if (currentUser) {
                showMainApp();
                updateUserInfo();
                loadGeneralMessages();
                loadAllUsersAndFriends(); // динамический список пользователей и друзей
            } else {
                showAuthScreen();
            }
        });
    </script>
</body>
</html>